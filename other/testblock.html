<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Load Blocks from JSON File</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    #blocklyDiv {
      height: 480px;
      width: 800px;
      border: 1px solid #ccc;
      margin-top: 20px;
    }
    .button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 10px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    .file-input {
      margin: 10px 0;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #dff0d8;
      color: #3c763d;
    }
    .error {
      background-color: #f2dede;
      color: #a94442;
    }
  </style>
</head>
<body>
  <h1>Blockly: Load Blocks from JSON File</h1>
  
  <div class="file-input">
    <input type="file" id="jsonFileInput" accept=".json" />
    <button id="loadBlocksBtn" class="button">Load Blocks from File</button>
    <button id="clearWorkspaceBtn" class="button">Clear Workspace</button>
  </div>
  
  <div id="statusArea" class="status" style="display: none;"></div>
  
  <div id="blocklyDiv"></div>
  
  <script>
    // Initialize Blockly workspace
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: {
        "kind": "flyoutToolbox",
        "contents": []
      },
      trashcan: true,
      grid: {
        spacing: 20,
        length: 3,
        colour: '#ccc',
        snap: true
      }
    });
    
    // Function to display status messages
    function showStatus(message, isError = false) {
      const statusArea = document.getElementById('statusArea');
      statusArea.style.display = 'block';
      statusArea.textContent = message;
      statusArea.className = isError ? 'status error' : 'status success';
    }
    
    // Function to create blocks from JSON
    function createBlocksFromJson(jsonDef) {
      try {
        // Clear any previously defined blocks
        for (const blockType in jsonDef.blocks) {
          if (Blockly.Blocks[blockType]) {
            delete Blockly.Blocks[blockType];
          }
        }
        
        // First define all block types
        for (const blockType in jsonDef.blocks) {
          const blockDef = jsonDef.blocks[blockType];
          Blockly.Blocks[blockType] = {
            init: function() {
              this.jsonInit(blockDef);
            }
          };
        }
        
        // Then add blocks to the workspace
        workspace.clear();
        const blockTypes = Object.keys(jsonDef.blocks);
        
        blockTypes.forEach((blockType, index) => {
          try {
            const block = workspace.newBlock(blockType);
            block.initSvg();
            block.render();
            block.setDeletable(true);
            block.setMovable(true);
            // Position blocks in a grid (3 columns)
            const col = index % 3;
            const row = Math.floor(index / 3);
            block.moveBy(50 + (col * 250), 50 + (row * 100));
          } catch (e) {
            console.error(`Error creating block ${blockType}:`, e);
            showStatus(`Error creating block ${blockType}: ${e.message}`, true);
          }
        });
        
        showStatus(`Successfully loaded ${blockTypes.length} blocks from JSON`);
      } catch (e) {
        console.error('Error processing JSON:', e);
        showStatus(`Error processing JSON: ${e.message}`, true);
      }
    }
    
    // Button event listeners
    document.getElementById('loadBlocksBtn').addEventListener('click', function() {
      const fileInput = document.getElementById('jsonFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showStatus('Please select a JSON file first', true);
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const jsonDef = JSON.parse(e.target.result);
          if (!jsonDef.blocks) {
            throw new Error('JSON file must contain a "blocks" object');
          }
          createBlocksFromJson(jsonDef);
        } catch (e) {
          console.error('Error parsing JSON:', e);
          showStatus(`Error parsing JSON: ${e.message}`, true);
        }
      };
      
      reader.onerror = function() {
        showStatus('Error reading file', true);
      };
      
      reader.readAsText(file);
    });
    
    document.getElementById('clearWorkspaceBtn').addEventListener('click', function() {
      workspace.clear();
      showStatus('Workspace cleared');
    });
  </script>
</body>
</html>